define(["./module-business.js"],function(z){return function(){function u(a,b){$.each(a,function(a,e){e.input=s(e.input,b)});return a}function r(a,b,d){var e=[];$.extend(!0,e,b);d=Array.isArray(d)?d:[d];e=u(e,d);f.fillFormData(a,e)}function A(a,b){var d=n(a),e=null,B=b||[c.filterBlock,c.dataBlock,c.pathBlock,c.dataSelectorContainer];d&&d.length&&$.each(B,function(a,b){var c=m(b,[d[0]]);if(f.form.isItem(c))return e=c,!1});return e}function m(a,b){var d=n(a),c=null;return d&&d.length?0!=d.indexOf(b[0])?
(d.unshift(b[0]),c=t(a),c+"__"+JSON.stringify(d)):a:s(a,b)}function s(a,b){b=Array.isArray(b)?b:[b];return a+"__"+JSON.stringify(b)}function n(a){a=a.split("__");return 1<a.length?JSON.parse(a[1]):null}function t(a){a=a.split("__");return a.length?a[0]:null}function p(a,b){if(a&&!a.hasOwnProperty("name")&&!a.hasOwnProperty("list"))return a;Array.isArray(a)?v(a,b):(a.hasOwnProperty("name")&&(a.name=m(a.name,b)),a.list&&a.list.length&&v(a.list,b));return a}function v(a,b){$.each(a,function(a,c){p(c,
b)})}function C(a,b){a.addBRules({code:function(a){a=a.form.getItemValue("code");b.setText(a)},"__btn;__regexp;^add_selector.*":function(a,b){var c=n(b),f=A(b),f=t(f),h,k;for(k in w)-1<w[k].indexOf(f)&&(h=k);g.addSelector(h,null,c[0])},"__btn;add_path_item":function(a,b){g.addPath()},"__btn;add_filter_item":function(a,b){g.addFilter()},"__btn;add_data_item":function(a,b){g.addData()},"__btn;__regexp;^delete_path_item.*":function(a,b){vv.confirm(vvMes.del,function(a){a&&(a=n(b),g.deletePath(a))})},
"__btn;__regexp;^delete_filter_item.*":function(a,b){vv.confirm(vvMes.del,function(a){a&&(a=n(b),g.deleteFilter(a))})},"__btn;__regexp;^delete_data_item.*":function(a,b){vv.confirm(vvMes.del,function(a){a&&(a=n(b),g.deleteData(a))})},"__btn;__regexp;^delete_selector.*":function(a,b){var c=n(b);g.deleteSelector(c)},"__regexp;^data_handler.*":function(a,b){var c=n(b),f=a.form.getCombo(b).getSelectedValue();"style"==f?(l.addDataStyle(a,c),l.deleteDataAttr(a,c)):("attribute"==f?l.addDataAttr(a,c):l.deleteDataAttr(a,
c),l.deleteDataStyle(a,c))},"__regexp;^path_handler.*":function(a,b){}})}function D(a){var b=a.code;x();h.setData(a,b);f.fillFormData(a,E);a.path&&a.path.length&&$.each(a.path,function(a,b){g.addPath(b)});a.data&&a.data.length&&$.each(a.data,function(a,b){g.addData(b)});a.filter&&a.filter.length&&$.each(a.filter,function(a,b){g.addFilter(b)})}function x(){var a=[c.dataBlock,c.filterBlock,c.pathBlock];f.form.forEachItem(function(b){var c=t(b);-1<a.indexOf(c)&&f.form.removeItem(b)})}function F(){return!0}
var q=null,f=null,y,h=z(),E=[{property:"listKey",input:"listKey"},{property:"code",input:"code"}],c={addSelector:"add_selector",deleteSelector:"delete_selector",dataBlock:"data_block",addDataBtn:"add_data_item",deleteDataBtn:"delete_data_item",dataSelectorContainer:"path_selector_container",dataContainer:"data_container",dataStyle:"data_style",dataAttr:"data_attr",dataHandlersAttached:"data_handlers_attached",pathBlock:"path_block",addPathBtn:"add_path_item",deletePathBtn:"delete_path_item",pathSelectorContainer:"path_selector_container",
pathPositionContainer:"path_position_container",pathPos:"position",pathContainer:"path_container",filterBlock:"filter_block",addFilterBtn:"add_filter_item",deleteFilterBtn:"delete_filter_item",filterSelectorContainer:"filter_selector_container",filterContainer:"filter_container",selectorBlock:"selector_block"},w={data:[c.dataBlock,c.addDataBtn,c.deleteDataBtn,c.dataSelectorContainer,c.dataContainer,c.dataStyle,c.dataAttr,c.dataHandlersAttached],filter:[c.filterBlock,c.addFilterBtn,c.deleteFilterBtn,
c.filterSelectorContainer,c.filterContainer],path:[c.pathBlock,c.addPathBtn,c.deletePathBtn,c.pathSelectorContainer,c.pathPositionContainer,c.pathPos,c.pathContainer]},k={getLevelMappings:function(){return[{property:"code",input:"code"},{property:"listKey",input:"listKey"}]},getDataItem:function(a){return{cfg:p({type:"block",name:c.dataBlock,inputWidth:"auto",className:"level-block data-block",blockOffset:10,list:[{type:"button",name:c.deleteDataBtn,value:"",className:"delete-item-min"},{type:"newcolumn"},
{type:"block",width:395,list:[{type:"input",name:"name",label:"Name"},{type:"block",name:c.dataSelectorContainer,width:390,blockOffset:0,list:[]},{type:"combo",name:"data_handler",label:"Handler",required:!0,readonly:!0,options:k._getItemHandlers()},{type:"block",name:c.dataHandlersAttached,width:390,blockOffset:0,list:[]}]}]},[a]),unique:JSON.stringify([a])}},getDataMappings:function(){return[{property:"name",input:"name"},{property:"handler",input:"data_handler"},{property:"attribute",input:"data_attr"},
{property:"style",input:"data_style"},{property:"formatter",input:"formatter"}]},getPathItem:function(a){return{cfg:p({type:"block",name:c.pathBlock,inputWidth:"auto",className:"level-block path-block",blockOffset:10,list:[{type:"button",name:c.deletePathBtn,value:"",className:"delete-item-min"},{type:"newcolumn"},{type:"block",width:395,list:[{type:"combo",name:"path_handler",label:"Handler",required:!0,readonly:!0,options:k._getPathHandlers()},{type:"input",name:c.pathPos,label:"Position"},{type:"block",
name:c.pathSelectorContainer,width:390,blockOffset:0,list:[]}]}]},[a]),unique:JSON.stringify([a])}},getPathMappings:function(){return[{property:"type",input:"path_handler"},{property:"pos",input:"position"}]},getFilterItem:function(a){return{cfg:p({type:"block",name:c.filterBlock,inputWidth:"auto",className:"level-block filter-block",blockOffset:10,list:[{type:"button",name:c.deleteFilterBtn,value:"",className:"delete-item-min"},{type:"newcolumn"},{type:"block",width:395,list:[{type:"block",name:c.filterSelectorContainer,
width:390,blockOffset:0,list:[]}]}]},[a]),unique:JSON.stringify([a])}},getFilterMappings:function(){return[]},getSelectorItem:function(a,b,d){return{cfg:p({type:"block",name:c.selectorBlock,blockOffset:0,width:390,offsetLeft:d?0:60,list:[{type:"input",name:"selector",label:d?"Selector":"",inputWidth:300,rows:3},{type:"newcolumn"},d?{type:"button",name:c.addSelector,value:"",className:"add-item-min"}:{type:"button",name:c.deleteSelector,value:"",className:"delete-item-min"}]},[a,b]),unique:JSON.stringify([a,
b])}},getSelectorMappings:function(){return[{property:"selector",input:"selector"}]},getDataStyle:function(a){a=Array.isArray(a)?a:[a];return{cfg:p({type:"input",name:c.dataStyle,label:"Style name"},a),unique:JSON.stringify(a)}},getDataAttr:function(a){a=Array.isArray(a)?a:[a];return{cfg:p({type:"input",name:c.dataAttr,label:"Attribute value"},a),unique:JSON.stringify(a)}},_getItemHandlers:function(){return[{value:"val",text:"Inner Html"},{value:"attribute",text:"Attribute Value"},{value:"style",
text:"Style"},{value:"notNull",text:"Not NULL"}]},_getPathHandlers:function(){return[{value:"sibl",text:"Siblings"},{value:"up",text:"Up by DOM"},{value:"down",text:"Down by DOM"}]},_getFilterHandlers:function(){return[["sel","Selector (is Exist)"]]},getMappingsByType:function(a){var b={data:k.getDataMappings,path:k.getPathMappings,filter:k.getFilterMappings,selector:k.getSelectorMappings,level:k.getLevelMappings};return"function"==typeof b[a]?b[a]():[]}},g={addPath:function(a){a?h.handleEntity(a,
"path"):a=h.action.add("path");l.addPath(a)},addFilter:function(a){a?h.handleEntity(a,"filter"):a=h.action.add("filter");l.addFilter(a)},addData:function(a){a?h.handleEntity(a,"data"):a=h.action.add("data");l.addData(a)},addSelector:function(a,b,c,e){b?h.handleEntity(b,"selector",[c]):b=h.action.addSelector(c);l.addSelector(a,b,c,e)},deletePath:function(a){h.action.remove("path",a);l.deletePath(a)},deleteFilter:function(a){h.action.remove("filter",a);l.deleteFilter(a)},deleteData:function(a){h.action.remove("data",
a);l.deleteData(a)},deleteSelector:function(a){a&&1<a.length&&h.action.removeSelector(a[1]);l.deleteSelector(a)},addDataStyle:function(a,b){},deleteDataStyle:function(a,b){},addDataAttr:function(a,b){},deleteDataAttr:function(a,b){},addPathPosition:function(a,b){},deletePathPosition:function(a,b){}},l={addPath:function(a){var b=h.getDataUn(a),c=k.getPathItem(b);f.form.addItem("path_container",{type:"newcolumn"});f.form.addItem("path_container",c.cfg);r(a,k.getPathMappings(),b);a.selectors&&a.selectors.length?
$.each(a.selectors,function(a,c){g.addSelector("path",c,b,!a)}):g.addSelector("path",null,b,!0);return c},addFilter:function(a){var b=h.getDataUn(a),c=k.getFilterItem(b);f.form.addItem("filter_container",{type:"newcolumn"});f.form.addItem("filter_container",c.cfg);r(a,k.getFilterMappings(),b);a.selectors&&a.selectors.length?$.each(a.selectors,function(a,c){g.addSelector("filter",c,b,!a)}):g.addSelector("filter",null,b,!0);return c},addData:function(a){var b=h.getDataUn(a),c=k.getDataItem(b);f.form.addItem("data_container",
{type:"newcolumn"});f.form.addItem("data_container",c.cfg);r(a,k.getDataMappings(),b);a.selectors&&a.selectors.length?$.each(a.selectors,function(a,c){g.addSelector("data",c,b,!a)}):g.addSelector("data",null,b,!0);return c},addSelector:function(a,b,d,e){var g=null;a=s({data:c.dataSelectorContainer,path:c.pathSelectorContainer,filter:c.filterSelectorContainer}[a],d);var l=h.getDataUn(b),g=k.getSelectorItem(d,l,e);f.form.addItem(a,g.cfg);r(b,k.getSelectorMappings(),[d,l]);return g},deletePath:function(a){a=
m(c.pathBlock,a);f.form.removeItem(a)},deleteFilter:function(a){a=m(c.filterBlock,a);f.form.removeItem(a)},deleteData:function(a){a=m(c.dataBlock,a);f.form.removeItem(a)},deleteSelector:function(a){a=m(c.selectorBlock,a);f.form.removeItem(a)},addDataStyle:function(a,b){var d=k.getDataStyle(b),e=m(c.dataHandlersAttached,b);a.form.isItem(d.cfg.name)||a.form.addItem(e,d.cfg)},deleteDataStyle:function(a,b){var d=m(c.dataStyle,b);a.form.removeItem(d)},addDataAttr:function(a,b){var d=k.getDataAttr(b),e=
m(c.dataHandlersAttached,b);a.form.isItem(d.cfg.name)||a.form.addItem(e,d.cfg)},deleteDataAttr:function(a,b){var d=m(c.dataAttr,b);a.form.removeItem(d)},addPathPosition:function(a,b){var d=k.getPathPosition(b),e=m(c.pathPositionContainer,b);a.form.isItem(d.cfg.name)||a.form.addItem(e,d.cfg)},deletePathPosition:function(a,b){var d=m(c.pathPos,b);a.form.removeItem(d)}};return q={init:function(a,b,d){a=y=a;var e;b=a.attachForm([{type:"settings",inputWidth:300,labelWidth:60,labelAlign:"left"},{type:"block",
width:"auto",blockOffset:8,list:[{type:"input",name:"code",label:"Code",validate:F},{type:"input",name:"listKey",label:"List key"},{type:"fieldset",label:"Pathes",offsetLeft:0,width:"auto",className:"top-border",list:[{type:"button",name:c.addPathBtn,value:"",className:"add-item",offsetTop:16},{type:"newcolumn"},{type:"block",name:c.pathContainer,blockOffset:6,width:"auto",list:[]}]},{type:"fieldset",label:"Filters",offsetLeft:0,width:"auto",className:"top-border",list:[{type:"button",name:c.addFilterBtn,
value:"",className:"add-item",offsetTop:16},{type:"newcolumn"},{type:"block",name:c.filterContainer,blockOffset:6,width:"auto",list:[]}]},{type:"fieldset",label:"Data",offsetLeft:0,width:"auto",className:"top-border",list:[{type:"button",name:c.addDataBtn,value:"",className:"add-item",offsetTop:16},{type:"newcolumn"},{type:"block",name:c.dataContainer,blockOffset:6,width:"auto",list:[]}]}]}]);e=(new FormController).init();b=(new FormComponent).init(b,e).initEvents();C(b,a);f=b;d&&(g.addData(),g.addFilter(),
g.addPath());h.setView(q);return q},getCode:function(){return f.form.getItemValue("code")},getData:function(){return h.getData()},setData:function(a){D(a);y.setText(a.code);return q},getComponent:function(){return f},clear:function(){x();return q},addCodeListener:function(a){f.addBRules({code:function(b,c,e){a(h.getPermanentCode(),e)}});return q},updateDataByMapping:function(a,b,c){var e=k.getMappingsByType(c),g=f.form.getFormData();e&&e.length&&(b="level"!==c?u(e,b):e,f.fillEntity(a,b,g))}}}});
